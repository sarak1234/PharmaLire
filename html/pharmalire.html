<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PharmaLire — Krahasues i Çmimeve të Barnave (Prishtinë)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2kG6t0k4tJp1Z2s0u6F2mT7S0s0e0s6q6b8g6Tg=" crossorigin=""/>
  <style>
    :root{--accent:#0b6cf2;--muted:#6b7280;--card:#ffffff;--bg:#f7f8fb}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
    header{background:linear-gradient(90deg,var(--accent),#4cc1ff);color:white;padding:18px 20px;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:1.25rem}
    .container{display:grid;grid-template-columns:400px 1fr;gap:18px;padding:18px}
    .panel{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(12,20,40,0.06)}
    #map{height:72vh;border-radius:10px}
    .ph-list{max-height:60vh;overflow:auto}
    .ph-item{padding:10px;border-radius:8px;border:1px solid #eef2f7;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .ph-item h3{margin:0;font-size:1rem}
    .price{font-weight:700}
    .controls{display:flex;gap:8px;margin-bottom:8px}
    input[type=search]{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef7}
    button{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    footer{padding:12px 20px;text-align:center;color:var(--muted);font-size:0.9rem}
    /* Modal / consent */
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:white;padding:18px;border-radius:10px;max-width:720px;width:96%;box-shadow:0 10px 30px rgba(10,20,40,0.12)}
    .modal h2{margin-top:0}
    .flex{display:flex;gap:10px}
    .muted{color:var(--muted);font-size:0.95rem}
    .small{font-size:0.9rem}
    .pill{background:#626d78;padding:6px 10px;border-radius:20px}
    .hidden{display:none}
    @media(max-width:900px){.container{grid-template-columns:1fr;}.panel{margin-bottom:12px}#map{height:50vh}}
  </style>
</head>
<body>
  <header>
    <h1>PharmaLire — Krahasues Çmimesh (Prishtinë)</h1>
    <div>
      <button id="locBtn">Përdor Lokacionin</button>
    </div>
  </header>

  <div class="container">
    <aside class="panel">
      <div class="controls">
        <input id="search" type="search" placeholder="Kërko barnë ose barnatore (p.sh. Paracetamol)" />
        <button id="showAll">Trego të gjitha</button>
      </div>

      <div class="ph-list" id="phList">
        <!-- Pharmacy result items injected here -->
      </div>

      <div style="margin-top:12px;">
        <h3>Rregullime dhe Legjislacion (shembull)</h3>
        <p class="muted small">Kjo platformë është vetëm një shembull. Para publikimit, sigurohuni të konsultoni një avokat për të përputhtuar kushtet me legjislacionin vendor (p.sh. Ligji për mbrojtjen e të dhënave personale dhe rregullat e farmacisë).</p>
      </div>
    </aside>

    <main>
      <div id="map" class="panel"></div>
      <div class="panel" style="margin-top:12px;">
        <h3>Rezultatet e krahasimit</h3>
        <table id="compareTable" style="width:100%;border-collapse:collapse">
          <thead><tr><th style="text-align:left">Barnatore</th><th style="text-align:left">Barnë</th><th>Çmimi</th><th>Disponueshmëria</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
  </div>

  <footer>
    <a href="#" id="openPrivacy">Politika e Privatësisë / Cookie</a> • <span id="consentState">Nuk ka dhënë pëlqim për cookies</span>
  </footer>

  <!-- Cookie / Location Consent Modal -->
  <div id="consentModal" class="modal-backdrop hidden">
    <div class="modal">
      <h2>PharmaLire — Miratimi për Cookies & Lokacion</h2>
      <p class="muted">Përpara se të përdorim cookies ose t'ju kërkojmë aksesin në lokacionin tuaj (për të gjetur barnatoret më të afërta), na lejoni të shpjegojmë pse i kërkojmë ato.</p>
      <ul>
        <li><strong>Cookies të domosdoshme:</strong> funksionalitet bazë i faqes (konsentet, sesionet).</li>
        <li><strong>Cookies analitike:</strong> për të përmirësuar shërbimin (opsionale).</li>
        <li><strong>Lokacioni:</strong> përdoret vetëm për t'ju treguar barnatoret më të afërta. Nuk ruajmë lokacionin pa pëlqim të qartë.</li>
      </ul>
      <div class="flex" style="margin-top:12px;justify-content:flex-end">
        <button id="rejectAll" style="background:#cbd5e1;color:#0b1724">Refuzo</button>
        <button id="acceptAll">Prano të gjitha</button>
      </div>
      <p class="muted small" style="margin-top:12px">Ju mund ta tërhiqni pëlqimin në çdo kohë nga <span class="pill">Cilësimet e Cookies</span>.</p>
    </div>
  </div>

  <!-- Privacy modal -->
  <div id="privacyModal" class="modal-backdrop hidden">
    <div class="modal">
      <h2>Politika e Privatësisë (Shembull)</h2>
      <p class="muted">Kjo është një politikë shembull dhe nuk zëvendëson këshillimin ligjor. Përmbajtja përfshin përshkrimin e të dhënave që mblidhen (emër barnatore, çmime, lokacion, cookies), qëllimin e përdorimit, bazën ligjore (pëlqimi), dhe të drejtat e subjektit të të dhënave (qasje, korrigjim, fshirje).</p>
      <h4>Përdorimi i Lokacionit</h4>
      <p class="muted small">Ne kërkojmë akses vetëm me pëlqim të qartë. Lokacioni përdoret vetëm për t'ju ofruar informacion të lokalizuar (barnatoret afër). Nëse pëlqeni, lokacioni mund të ruhet përkohësisht në localStorage dhe të fshihet pas përfundimit të shfletimit.</p>
      <h4>Cookies</h4>
      <p class="muted small">Shfrytëzojmë cookies të domosdoshme dhe analitike. Përdoruesi mund të pranojë/refuzojë cookies analitike. Cookies e domosdoshme nuk kërkojnë pëlqim për funksionim bazë.</p>
      <div style="text-align:right;margin-top:12px"><button id="closePrivacy">Mbyll</button></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-Vd1fQq+Zedb0M0VqY9Zb9r0qzV7xjV0t6hJc1bE6k8M=" crossorigin=""></script>
  <script>
    // --- SAMPLE DATA ---
    // These are example pharmacy records. Replace this list with real API calls.
    const pharmacies = [
      {id:1,name:'Farmacia A',lat:42.6629,lng:21.1655,address:'Rr. Njomza',items:[{name:'Paracetamol 500mg',price:1.50,available:true},{name:'Ibuprofen 200mg',price:2.00,available:false}]},
      {id:2,name:'Farmacia B',lat:42.6580,lng:21.1700,address:'Rr. B',items:[{name:'Paracetamol 500mg',price:1.20,available:true},{name:'Aspirine 100mg',price:3.40,available:true}]},
      {id:3,name:'Farmacia C',lat:42.6660,lng:21.1600,address:'Rr. C',items:[{name:'Paracetamol 500mg',price:1.70,available:false},{name:'Ibuprofen 200mg',price:1.90,available:true}]}
    ];

    // --- STATE & CONSENT ---
    const consentKey = 'pharmalire_consent_v1';
    function getConsent(){try{return JSON.parse(localStorage.getItem(consentKey))||{}}catch(e){return{}}}
    function setConsent(obj){localStorage.setItem(consentKey,JSON.stringify(obj));renderConsentState()}
    function renderConsentState(){const s=document.getElementById('consentState');const c=getConsent();s.textContent = c.cookiesAnalytic? 'Cookies: pranuar' : 'Cookies: refuzuar';}

    // --- MAP ---
    const map = L.map('map',{zoomControl:true}).setView([42.6629,21.1655],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap contributors'}).addTo(map);
    const markers = {};

    function renderPharmacies(list){
      const phList = document.getElementById('phList'); phList.innerHTML='';
      const tbody = document.querySelector('#compareTable tbody'); tbody.innerHTML='';
      list.forEach(p=>{
        // list item
        const div = document.createElement('div'); div.className='ph-item';
        const left = document.createElement('div'); left.innerHTML = `<h3>${p.name}</h3><div class="muted small">${p.address}</div>`;
        const right = document.createElement('div'); right.innerHTML = `<button data-id="${p.id}">Shiko</button>`;
        div.append(left,right); phList.append(div);

        // marker
        if(markers[p.id]){markers[p.id].setLatLng([p.lat,p.lng]);} else {
          const m = L.marker([p.lat,p.lng]).addTo(map).bindPopup(`<strong>${p.name}</strong><br>${p.address}`);
          markers[p.id]=m;
        }

        // compare table rows
        p.items.forEach(it=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p.name}</td><td>${it.name}</td><td style="text-align:right">€ ${it.price.toFixed(2)}</td><td style="text-align:center">${it.available? '✅':'❌'}</td>`;
          tbody.append(tr);
        });
      });
    }

    // initial render
    renderPharmacies(pharmacies);

    // search filter
    document.getElementById('search').addEventListener('input',e=>{
      const q = e.target.value.toLowerCase();
      const filtered = pharmacies.filter(p=>p.name.toLowerCase().includes(q) || p.address.toLowerCase().includes(q) || p.items.some(it=>it.name.toLowerCase().includes(q)));
      renderPharmacies(filtered);
    });
    document.getElementById('showAll').addEventListener('click',()=>{document.getElementById('search').value='';renderPharmacies(pharmacies)});

    // clicking "Shiko" opens marker popup + pan
    document.getElementById('phList').addEventListener('click',e=>{
      const btn = e.target.closest('button'); if(!btn) return; const id = Number(btn.dataset.id);
      const p = pharmacies.find(x=>x.id===id); if(!p) return; map.setView([p.lat,p.lng],16); markers[id].openPopup();
    });

    // --- GEOLOCATION (ONLY AFTER CONSENT) ---
    async function requestGeolocation(){
      const consent = getConsent();
      if(!consent.allowLocation){alert('Lokacioni nuk është pranuar.'); return}
      if(!navigator.geolocation){alert('Geolocation nuk mbështetet nga shfletuesi juaj.');return}
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude, lng=pos.coords.longitude; map.setView([lat,lng],14);
        L.circle([lat,lng],{radius:100,opacity:0.4}).addTo(map).bindPopup('Ju jeni këtu').openPopup();
      },err=>{alert('Nuk u mor leja për lokacion: '+err.message)} ,{enableHighAccuracy:false,timeout:8000});
    }

    document.getElementById('locBtn').addEventListener('click',()=>{
      // show consent modal if not decided
      const c=getConsent(); if(!('allowLocation' in c) || !('cookiesAnalytic' in c)){
        showConsentModal(); return; }
      requestGeolocation();
    });

    // Consent modal logic
    function showConsentModal(){document.getElementById('consentModal').classList.remove('hidden');}
    function hideConsentModal(){document.getElementById('consentModal').classList.add('hidden');}
    document.getElementById('acceptAll').addEventListener('click',()=>{setConsent({cookiesAnalytic:true,allowLocation:true});hideConsentModal();});
    document.getElementById('rejectAll').addEventListener('click',()=>{setConsent({cookiesAnalytic:false,allowLocation:false});hideConsentModal();});

    // privacy modal
    document.getElementById('openPrivacy').addEventListener('click',e=>{e.preventDefault();document.getElementById('privacyModal').classList.remove('hidden')});
    document.getElementById('closePrivacy').addEventListener('click',()=>{document.getElementById('privacyModal').classList.add('hidden')});

    // initialize consent state on load
    (function initConsent(){
      if(!localStorage.getItem(consentKey)){ // default: show modal so user picks
        showConsentModal();
      }
      renderConsentState();
    })();

    // Expose a function to withdraw consent (example)
    window.withdrawConsent = function(){setConsent({cookiesAnalytic:false,allowLocation:false});alert('Pëlqimet janë tërhequr.');}

    // --- SECURITY & PRIVACY NOTES (developer reminder) ---
    /*
      - Kur integroni me API reale: përdorni HTTPS, autentikim për furnizuesit e çmimeve, rate-limiting.
      - Mos ruani lokacionin pa pëlqim eksplicit; nëse ruani, vendosni kohë të kufizuar ruajtjeje.
      - Para publikimit, merrni këshillimin e një avokati për politikën e privatësisë dhe pajtueshmërinë me ligjet lokale (p.sh. GDPR, ligjet vendore në Kosovë).
    */
  </script>
</body>
</html>
